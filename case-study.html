<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 18 Case study | Bioconductor Package Guidelines for Developers and Reviewers</title>
<meta name="author" content="Kevin Rue-Albrecht">
<meta name="author" content="Daniela Cassol">
<meta name="author" content="Johannes Rainer">
<meta name="author" content="Lori Shepherd">
<meta name="description" content="As a case study, a colleague reported that their complicated program would, on one particular computer, produce a segmentation fault or just stop responding. The same series of actions wouldn’t...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 18 Case study | Bioconductor Package Guidelines for Developers and Reviewers">
<meta property="og:type" content="book">
<meta property="og:description" content="As a case study, a colleague reported that their complicated program would, on one particular computer, produce a segmentation fault or just stop responding. The same series of actions wouldn’t...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 18 Case study | Bioconductor Package Guidelines for Developers and Reviewers">
<meta name="twitter:description" content="As a case study, a colleague reported that their complicated program would, on one particular computer, produce a segmentation fault or just stop responding. The same series of actions wouldn’t...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Bioconductor Package Guidelines for Developers and Reviewers</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">About Bioconductor</a></li>
<li class="book-part">Package Development Guidelines</li>
<li><a class="" href="develop-overview.html">Overview</a></li>
<li><a class="" href="package-name.html"><span class="header-section-number">1</span> Package name</a></li>
<li><a class="" href="general.html"><span class="header-section-number">2</span> General Package Development</a></li>
<li><a class="" href="description.html"><span class="header-section-number">3</span> The DESCRIPTION file</a></li>
<li><a class="" href="biocviews-1.html"><span class="header-section-number">4</span> biocViews</a></li>
<li><a class="" href="namespace.html"><span class="header-section-number">5</span> The NAMESPACE file</a></li>
<li><a class="" href="news.html"><span class="header-section-number">6</span> The NEWS file</a></li>
<li><a class="" href="citation.html"><span class="header-section-number">7</span> The CITATION file</a></li>
<li><a class="" href="data.html"><span class="header-section-number">8</span> Package data</a></li>
<li><a class="" href="docs.html"><span class="header-section-number">9</span> Documentation</a></li>
<li><a class="" href="tests.html"><span class="header-section-number">10</span> Unit tests</a></li>
<li><a class="" href="long-tests.html"><span class="header-section-number">11</span> Long Tests</a></li>
<li><a class="" href="r-code.html"><span class="header-section-number">12</span> R code</a></li>
<li><a class="" href="common-bioconductor-methods-and-classes.html"><span class="header-section-number">13</span> Common Bioconductor Methods and Classes</a></li>
<li><a class="" href="robust-and-efficient-code.html"><span class="header-section-number">14</span> Robust and Efficient Code</a></li>
<li><a class="" href="c-fortran.html"><span class="header-section-number">15</span> C and Fortran code</a></li>
<li><a class="" href="cmavericks-best-practices.html"><span class="header-section-number">16</span> C++/Mavericks Best Practices</a></li>
<li><a class="" href="debugging-cc-code.html"><span class="header-section-number">17</span> Debugging C/C++ code</a></li>
<li><a class="active" href="case-study.html"><span class="header-section-number">18</span> Case study</a></li>
<li><a class="" href="querying-web-resources.html"><span class="header-section-number">19</span> Querying Web Resources</a></li>
<li><a class="" href="third-party-code.html"><span class="header-section-number">20</span> Third-party code</a></li>
<li><a class="" href="shiny.html"><span class="header-section-number">21</span> Shiny apps</a></li>
<li><a class="" href="non-software.html"><span class="header-section-number">22</span> Non-Software Packages</a></li>
<li><a class="" href="package-end-of-life-policy.html"><span class="header-section-number">23</span> Package End of Life Policy</a></li>
<li><a class="" href="gitignore.html"><span class="header-section-number">24</span> The .gitignore file</a></li>
<li><a class="" href="conclusion.html"><span class="header-section-number">25</span> Conclusion</a></li>
<li><a class="" href="references-1.html">References</a></li>
<li class="book-part">Package Reviewer Resources</li>
<li><a class="" href="reviewer-resources-overview.html">Overview</a></li>
<li><a class="" href="review-expectation.html"><span class="header-section-number">26</span> Review Expectations</a></li>
<li><a class="" href="reviewtools.html"><span class="header-section-number">27</span> Reviewer Resources and Tools</a></li>
<li><a class="" href="review-volunteer-chapter.html"><span class="header-section-number">28</span> Volunteer to Review</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="booknews.html"><span class="header-section-number">A</span> NEWS</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/Bioconductor/pkgrevdocs">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="case-study" class="section level1" number="18">
<h1>
<span class="header-section-number">18</span> Case study<a class="anchor" aria-label="anchor" href="#case-study"><i class="fas fa-link"></i></a>
</h1>
<p>As a case study, a colleague reported that their complicated program
would, on one particular computer, produce a segmentation fault or
just stop responding. The same series of actions wouldn’t cause
problems on other computers. This sounds like a classic memory
problem, with the segfault and difficulty of reproduction.</p>
<p>The first advice was to develop a simple script that reproduced the
problem: the original report had too many moving parts. A big insight
was that the bug could be produced by running part of the code that
uses RCurl, followed by a call to the garbage collector, <code><a href="https://rdrr.io/r/base/gc.html">gc()</a></code>. The
role of the garbage collector suggests again memory corruption of some
sort, and in particular that perhaps RCurl is allocating (at the C
level) an R object but not properly PROTECT’ing it from garbage
collection. We suspect RCurl rather than R or libcurl (other possible
players) because it is the least tested of the code. We could be
wrong, of course… After many iterations, my colleague arrived at
buggy24.R:</p>
<pre><code><a href="https://rdrr.io/r/base/library.html">library(RCurl)

foo &lt;- function() {
    url &lt;- "https://google.com"
    curl &lt;- getCurlHandle()
    opts &lt;- list(followlocation=NULL, ssl.verifypeer=TRUE)
    d &lt;- debugGatherer()
    getURL(url,customrequest="GET",curl=curl,debugfunction=d$update,.opts=opts)
}

execute &lt;- function() {
    foo()
    gc()
}

execute()</a></code></pre>
<p>This is pretty simple, and doesn’t require access to any special
resources (like the server that was originally being queried). This
script doesn’t cause a segfault when run on all systems, but running
valgrind (having installed RCurl without any optimizations) shows…</p>
<pre><code>&gt; R -d valgrind -f buggy24.R
...
==10859== Conditional jump or move depends on uninitialised value(s)
==10859==    at 0x11BF00F6: getCurlPointerForData (curl.c:798)
==10859==    by 0x11BF0E80: R_curl_easy_setopt (curl.c:164)
==10859==    by 0x11BF17AD: R_curl_easy_perform (curl.c:89)
==10859==    by 0x4ED5499: do_dotcall (dotcode.c:588)
==10859==    by 0x4F1CAA4: Rf_eval (eval.c:593)
==10859==    by 0x4F2BD5C: do_set (eval.c:1828)
==10859==    by 0x4F1C8B7: Rf_eval (eval.c:567)
==10859==    by 0x4F2B957: do_begin (eval.c:1514)
==10859==    by 0x4F1C8B7: Rf_eval (eval.c:567)
==10859==    by 0x4F297E9: Rf_applyClosure (eval.c:960)
==10859==    by 0x4F1CBA5: Rf_eval (eval.c:611)
==10859==    by 0x4F2BD5C: do_set (eval.c:1828)</code></pre>
<p>Look around the C source code in RCurl’s curl.c, as suggested by the
backtrace, just to get oriented. Then do</p>
<pre><code>R -d gdb -f buggy24.R</code></pre>
<p>to run the script under gdb. Run our test script</p>
<pre><code>(gdb) r</code></pre>
<p>No error. Don’t give up, set a break point</p>
<pre><code>(gdb) b curl.c:798</code></pre>
<p>and run again</p>
<pre><code>(gdb) r
Breakpoint 1, getCurlPointerForData (el=0x79e038,
    option=CURLOPT_WRITEFUNCTION, isProtected=FALSE, curl=0x1d9bdc0)
    at curl.c:798
798    curl.c: No such file or directory.
(gdb)</code></pre>
<p>That ‘no such file’ means that gdb doesn’t know where to find the
RCurl package src/ directory, so tell it and (l)ist the context, and
(p)rint the value of the C variable <code>isProtected</code>, which seems to be
the source of the valgrind warning</p>
<pre><code>(gdb) dir ~/tmp/RCurl/src
(gdb) l
793                        }
794                    }
795                }
796                break;
797              case CLOSXP:
798              (gdb) l
793                        }
794                    }
795                }
796                break;
797              case CLOSXP:
798                  if(!isProtected) {
799                R_PreserveObject(el);
800                }
801                ptr = (void *) el;
802                break;
(gdb) p isProtected
$5 = FALSE</code></pre>
<p><code>isProtected</code> has a value (it has to!), and furthermore the value of
FALSE results in PROTECT’ing the object <code>el</code> across C calls (this is
what <code>R_PreserveObject</code> does). This is pretty interesting, because
we’re aware that garbage collection triggers the segfault. valgrind is
telling us that the value of <code>isProtected</code> isn’t actually the result
of an assignment, it could be the result of accessing an array out of
bounds. Let’s head up the call stack and see where this value is
coming from</p>
<pre><code>(gdb) up
#1  0x00007ffff426e273 in R_curl_easy_setopt (handle=0x15d9600,
    values=0x1445788, opts=0xf3d418, isProtected=0xb7d308, encoding=0x776db0)
    at curl.c:164
164            val = getCurlPointerForData(el, opt, LOGICAL(isProtected)[ i % n ], obj);
(gdb) l
159        /* Loop over all the options we are setting. */
160        for(i = 0; i &lt; n; i++) {
161            opt = INTEGER(opts)[i];
162            el = VECTOR_ELT(values, i);
163                 /* Turn the R value into something we can use in libcurl. */
164            val = getCurlPointerForData(el, opt, LOGICAL(isProtected)[ i % n ], obj);
165
166                    if(opt == CURLOPT_WRITEFUNCTION &amp;&amp; TYPEOF(el) == CLOSXP) {
167                data-&gt;fun = val; useData++;
168                status =  curl_easy_setopt(obj, CURLOPT_WRITEFUNCTION, &amp;R_curl_write_data);
(gdb)</code></pre>
<p>We’re entering the function <code>getCurlPointerForData</code> with the value
<code>LOGICAL(isProtected)[ i % n ]</code>. Here, <code>isProtected</code> is now an R
object, not a C variable. Looking at the surrounding code, that <code>i % n</code> doesn’t look right – it’s probably meant to recycle <code>isProtected</code>
in the case where a shorter logical variable is provided than the
vector of elements requiring protection, but the value of <code>n</code> is not
necessarily the length of <code>isProtected</code>. Let’s have a look at what
we’ve got, using a C-level R function <code>Rf_PrintValue</code> to print R
values (SEXP’s) in an R fashion</p>
<pre><code>(gdb) p isProtected
$1 = (SEXP) 0xaad8a0
(gdb) call Rf_PrintValue(isProtected )
[1] FALSE</code></pre>
<p><code>isProtected</code> is a logical vector of length 1.</p>
<pre><code>(gdb) p i
$7 = 1
(gdb) p n
$8 = 6
(gdb) p i % n
$9 = 1</code></pre>
<p>…and we’re trying to access element 1 of it. But the C
representation of R vectors is zero-based, so the only valid value of
the index is 0 – we’re out of bounds! This could well be our bug, and
it’s time to try fixing it (naively,
<code>LOGICAL(isProtected)[ i % LENGTH(isProtected) ]</code>) to confirm our
diagnosis, or report to the <code>packageDescription("RCurl")$Maintainer</code>
who might have a better sense of the overall structure and intention
of the code.</p>

</div>
  <div class="chapter-nav">
<div class="prev"><a href="debugging-cc-code.html"><span class="header-section-number">17</span> Debugging C/C++ code</a></div>
<div class="next"><a href="querying-web-resources.html"><span class="header-section-number">19</span> Querying Web Resources</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav"><li><a class="nav-link" href="#case-study"><span class="header-section-number">18</span> Case study</a></li></ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/Bioconductor/pkgrevdocs/blob/master/11b-cDebugging.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/Bioconductor/pkgrevdocs/edit/master/11b-cDebugging.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bioconductor Package Guidelines for Developers and Reviewers</strong>" was written by Kevin Rue-Albrecht, Daniela Cassol, Johannes Rainer, Lori Shepherd. It was last built on 2021-10-22.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
