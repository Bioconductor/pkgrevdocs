<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 17 Robust and Efficient Code | Bioconductor Packages: Development, Maintenance, and Peer Review</title>
<meta name="author" content="Kevin Rue-Albrecht">
<meta name="author" content="Daniela Cassol">
<meta name="author" content="Johannes Rainer">
<meta name="author" content="Lori Shepherd">
<meta name="description" content="R can be a robust, fast and efficient programming language, but some coding practices can be very unfortunate. Here are some suggestions.  17.1 Guiding Principles The primary principle is to make...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="Chapter 17 Robust and Efficient Code | Bioconductor Packages: Development, Maintenance, and Peer Review">
<meta property="og:type" content="book">
<meta property="og:description" content="R can be a robust, fast and efficient programming language, but some coding practices can be very unfortunate. Here are some suggestions.  17.1 Guiding Principles The primary principle is to make...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 17 Robust and Efficient Code | Bioconductor Packages: Development, Maintenance, and Peer Review">
<meta name="twitter:description" content="R can be a robust, fast and efficient programming language, but some coding practices can be very unfortunate. Here are some suggestions.  17.1 Guiding Principles The primary principle is to make...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Bioconductor Packages: Development, Maintenance, and Peer Review</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li class="book-part">Package Development Guidelines</li>
<li><a class="" href="develop-overview.html">Overview</a></li>
<li><a class="" href="package-name.html"><span class="header-section-number">1</span> Package name</a></li>
<li><a class="" href="general.html"><span class="header-section-number">2</span> General Package Development</a></li>
<li><a class="" href="use-devel.html"><span class="header-section-number">3</span> Using the ‘Devel’ Version of Bioconductor</a></li>
<li><a class="" href="description.html"><span class="header-section-number">4</span> The DESCRIPTION file</a></li>
<li><a class="" href="biocviews-1.html"><span class="header-section-number">5</span> biocViews</a></li>
<li><a class="" href="version-numbering.html"><span class="header-section-number">6</span> Version Numbering</a></li>
<li><a class="" href="namespace.html"><span class="header-section-number">7</span> The NAMESPACE file</a></li>
<li><a class="" href="news.html"><span class="header-section-number">8</span> The NEWS file</a></li>
<li><a class="" href="citation.html"><span class="header-section-number">9</span> The CITATION file</a></li>
<li><a class="" href="data.html"><span class="header-section-number">10</span> Package data</a></li>
<li><a class="" href="docs.html"><span class="header-section-number">11</span> Documentation</a></li>
<li><a class="" href="tests.html"><span class="header-section-number">12</span> Unit tests</a></li>
<li><a class="" href="long-tests.html"><span class="header-section-number">13</span> Long Tests</a></li>
<li><a class="" href="troubleshooting-build-report.html"><span class="header-section-number">14</span> Troubleshooting Build Report</a></li>
<li><a class="" href="r-code.html"><span class="header-section-number">15</span> R code</a></li>
<li><a class="" href="common-bioconductor-methods-and-classes.html"><span class="header-section-number">16</span> Common Bioconductor Methods and Classes</a></li>
<li><a class="active" href="robust-and-efficient-code.html"><span class="header-section-number">17</span> Robust and Efficient Code</a></li>
<li><a class="" href="c-fortran.html"><span class="header-section-number">18</span> C and Fortran code</a></li>
<li><a class="" href="cmavericks-best-practices.html"><span class="header-section-number">19</span> C++/Mavericks Best Practices</a></li>
<li><a class="" href="debugging-cc-code.html"><span class="header-section-number">20</span> Debugging C/C++ code</a></li>
<li><a class="" href="querying-web-resources.html"><span class="header-section-number">21</span> Querying Web Resources</a></li>
<li><a class="" href="third-party-code.html"><span class="header-section-number">22</span> Third-party code</a></li>
<li><a class="" href="workflow-packages.html"><span class="header-section-number">23</span> Workflow Packages</a></li>
<li><a class="" href="shiny.html"><span class="header-section-number">24</span> Shiny apps</a></li>
<li><a class="" href="non-software.html"><span class="header-section-number">25</span> Non-Software Packages</a></li>
<li><a class="" href="package-end-of-life-policy.html"><span class="header-section-number">26</span> Package End of Life Policy</a></li>
<li><a class="" href="gitignore.html"><span class="header-section-number">27</span> The .gitignore file</a></li>
<li><a class="" href="git-version-control.html"><span class="header-section-number">28</span> Git Version Control</a></li>
<li><a class="" href="conclusion.html"><span class="header-section-number">29</span> Conclusion</a></li>
<li><a class="" href="references-1.html">References</a></li>
<li class="book-part">Package Submissions</li>
<li><a class="" href="software-package-submissions.html"><span class="header-section-number">30</span> Software Package Submissions</a></li>
<li class="book-part">Package Reviewer Resources</li>
<li><a class="" href="reviewer-resources-overview.html">Overview</a></li>
<li><a class="" href="review-expectation.html"><span class="header-section-number">31</span> Review Expectations</a></li>
<li><a class="" href="reviewtools.html"><span class="header-section-number">32</span> Reviewer Resources and Tools</a></li>
<li><a class="" href="review-volunteer-chapter.html"><span class="header-section-number">33</span> Volunteer to Review</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="booknews.html"><span class="header-section-number">A</span> NEWS</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/Bioconductor/pkgrevdocs">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="robust-and-efficient-code" class="section level1" number="17">
<h1>
<span class="header-section-number">17</span> Robust and Efficient Code<a class="anchor" aria-label="anchor" href="#robust-and-efficient-code"><i class="fas fa-link"></i></a>
</h1>
<p><em>R</em> can be a robust, fast and efficient programming language, but some
coding practices can be very unfortunate. Here are some suggestions.</p>
<div id="guiding-principles" class="section level2" number="17.1">
<h2>
<span class="header-section-number">17.1</span> Guiding Principles<a class="anchor" aria-label="anchor" href="#guiding-principles"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>The primary principle is to make sure your code is <strong>correct</strong>. Use
<code><a href="https://rdrr.io/r/base/identical.html">identical()</a></code> or <code><a href="https://rdrr.io/r/base/all.equal.html">all.equal()</a></code> to ensure correctness, and
<a href="tests.html#tests">unit tests</a> to ensure consistent results across code revisions.</p></li>
<li><p>Write robust code. Avoid efficiencies that do not easily handle
edge cases such as 0 length or <code>NA</code> values.</p></li>
<li><p>Know when to stop trying to be efficient. If the code takes a
fraction of a second to evaluate, there is no sense in trying for
further improvement. Use <code><a href="https://rdrr.io/r/base/system.time.html">system.time()</a></code> or a package like
<a href="https://cran.r-project.org/web/packages/microbenchmark">microbenchmark</a> to quantify performance gains.</p></li>
</ol>
</div>
<div id="common-advice" class="section level2" number="17.2">
<h2>
<span class="header-section-number">17.2</span> Common Advice<a class="anchor" aria-label="anchor" href="#common-advice"><i class="fas fa-link"></i></a>
</h2>
<div id="vectorize" class="section level3" number="17.2.1">
<h3>
<span class="header-section-number">17.2.1</span> Vectorize<a class="anchor" aria-label="anchor" href="#vectorize"><i class="fas fa-link"></i></a>
</h3>
<p>Vectorize, rather than iterate (<code>for</code> loops, <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>, <code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code> are
common iteration idioms in <em>R</em>). A single call <code>y &lt;- sqrt(x)</code> with a
vector <code>x</code> of length <code>n</code> is an example of a vectorized function. A
call such as <code>y &lt;- sapply(x, sqrt)</code> or a <code>for</code> loop <code>for (i in seq_along(x)) y[i] &lt;- sqrt(x[i])</code> is an iterative version of the same
call, and should be avoided. Often, iterative calculations that can be
vectorized are “hidden” in the body of a <code>for</code> loop</p>
<pre><code>for (i in seq_len(n)) {
    ## ...
    tmp &lt;- foo(x[i])
    y &lt;- tmp + ## ...
}</code></pre>
<p>and can be ‘hoisted’ out of the loop</p>
<pre><code>tmp &lt;- foo(x)
for (i in seq_len(n)) {
    ## ...
    y &lt;- tmp[i] + ##
}</code></pre>
<p>Often this principle can be applied repeatedly, and an iterative
<code>for</code> loop becomes a few lines of vectorized function calls.</p>
</div>
<div id="pre-allocate-and-fill-if-iterations-are-necessary" class="section level3" number="17.2.2">
<h3>
<span class="header-section-number">17.2.2</span> ‘Pre-allocate and fill’ if iterations are necessary<a class="anchor" aria-label="anchor" href="#pre-allocate-and-fill-if-iterations-are-necessary"><i class="fas fa-link"></i></a>
</h3>
<p>Preallocate-and-fill (usually via <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> or <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code>) rather
than copy-and-append. If creating a vector or list of results, use
<code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> (to create a list) or <code><a href="https://rdrr.io/r/base/lapply.html">vapply()</a></code> (to create a vector)
rather than a <code>for</code> loop. For instance,</p>
<pre><code>n &lt;- 10000
x &lt;- vapply(seq_len(n), function(i) {
    ## ...
}, integer(1))</code></pre>
<p>manages the memory allocation of <code>x</code> and compactly represents the
transformation being performed. A <code>for</code> loop might be appropriate if
the iteration has side effects (e.g., displaying a plot) or where
calculation of one value depends on a previous value. When creating a
vector in a <code>for</code> loop, always pre-allocate the result</p>
<pre><code>x &lt;- integer(n)
if (n &gt; 0) x[1] &lt;- 0
for (i in seq_len(n - 1)) {
    ## x[i + 1] &lt;- ...
}</code></pre>
<p><strong>Never</strong> adopt a strategy of ‘copy-and-append’</p>
<pre><code>not_this &lt;- function(n) {
    x &lt;- integer()
    for (i in seq_len(n))
        x[i] = i
    x
}</code></pre>
<p>This pattern copies the current value of <code>x</code> each time through the
loop, making <code>n^2 / 2</code> total copies, and scale very poorly even for
trivial computations:</p>
<pre><code>&gt; system.time(not_this(1000)
   user  system elapsed
  0.004   0.000   0.004
&gt; system.time(not_this(10000))
   user  system elapsed
  0.169   0.000   0.168
&gt; system.time(not_this(100000))
   user  system elapsed
 22.827   1.120  23.936</code></pre>
</div>
<div id="avoid-1n-style-iterations" class="section level3" number="17.2.3">
<h3>
<span class="header-section-number">17.2.3</span> Avoid <code>1:n</code> style iterations<a class="anchor" aria-label="anchor" href="#avoid-1n-style-iterations"><i class="fas fa-link"></i></a>
</h3>
<p>Write <code>seq_len(n)</code> or <code>seq_along(x)</code> rather than <code>1:n</code> or
<code>1:length(x)</code>. This protects against the case when <code>n</code> or <code>length(x)</code>
is 0 (which often occurs as an unexpected ‘edge case’ in real code) or
negative.</p>
</div>
<div id="re-use-existing-functionality" class="section level3" number="17.2.4">
<h3>
<span class="header-section-number">17.2.4</span> Re-use existing functionality<a class="anchor" aria-label="anchor" href="#re-use-existing-functionality"><i class="fas fa-link"></i></a>
</h3>
<p>For common input formats see <a href="common-bioconductor-methods-and-classes.html#common-bioconductor-methods-and-classes">common <em>Bioconductor</em> methods and classes</a></p>
<p>If there are problems, e.g., in performance or parsing your particular
file type, ask for input from other developers on the bioc-devel
mailing list. Common disadvantages to ‘implementing your own’ are the
introduction of non-standard data representations (e.g., neglecting to
translate coordinate systems of file formats to Bioconductor objects)
and user bewilderment.</p>
</div>
<div id="re-use-existing-classes" class="section level3" number="17.2.5">
<h3>
<span class="header-section-number">17.2.5</span> Re-use existing classes<a class="anchor" aria-label="anchor" href="#re-use-existing-classes"><i class="fas fa-link"></i></a>
</h3>
<p>Re-use enhances interoperability between <em>Bioconductor</em> packages while
providing robust code for data manipulation.</p>
<p>Use <code>GenomicRanges::GRanges</code> (and <code>GRangesList</code>) to represent 1-based,
closed-interval genomic coordinates.</p>
<p>Use <code>SummarizedExperiment::SummarizedExperiment</code> (with or without
ranges as row data) to coordinate rectangular feature x sample data
(e.g., RNAseq count matrix) with feature and sample description. Use
<code>SummarizedExperiment</code> rather than the older <code>ExpressionSet</code>,
especially for sequence data.</p>
<p>For more existing classes see <a href="common-bioconductor-methods-and-classes.html#common-bioconductor-methods-and-classes">common <em>Bioconductor</em> methods and classes</a></p>
</div>
<div id="essential-s4-interface" class="section level3" number="17.2.6">
<h3>
<span class="header-section-number">17.2.6</span> Essential S4 interface<a class="anchor" aria-label="anchor" href="#essential-s4-interface"><i class="fas fa-link"></i></a>
</h3>
<p>Remember to <strong>re-use</strong> <a href="common-bioconductor-methods-and-classes.html#common-bioconductor-methods-and-classes">common <em>Bioconductor</em> methods and classes</a>
before implementing new representations. This encourages
interoperability and simplifies your own package development.</p>
<p>If your data requires a new representation or function, carefully
design an S4 class or generic so that other package developers with
similar needs will be able to re-use your hard work, and so that users
of related packages will be able to seamlessly use your data
structures. Do not hesitate to ask on the Bioc-devel mailing list for
advice.</p>
<p>For any class you define, implement and use a ‘constructor’ for object
creation. A constructor is usually plain-old-function (rather than,
e.g., a generic with methods). It provides documented and
user-friendly arguments, while allowing for developer-friendly
implementation. Use the constructor throughout your own code,
examples, and vignette.</p>
<p>Implement a <code>show()</code> method to effectively convey information to your
users without overwhelming them with detail.</p>
<p>Accessors (simple functions that return components of your object)
rather than direct slot access (using <code>@</code>) help to isolate the
implementation of your class from its interface. Generally <code>@</code> should
only be used in an accessor, all other code should use the
accessor. The accessor does not need to be exported from the class if
the user has no need or business accessing parts of your data
object. Plain-old-functions (rather than generic + method) are often
sufficient for accessors; it’s often useful to employ (consistently) a
lightweight name mangling scheme (e.g., starting the accessor method
name with a 2 or 3 letter acronym for your package) to avoid name
collisions between similarly named functions in other packages.</p>
<p>The following layout is sometimes used to organize classes and
methods; other approaches are possible and acceptable.</p>
<ul>
<li>All class definitions in R/AllClasses.R</li>
<li>All generic function definitions in R/AllGenerics.R</li>
<li>Methods are defined in a file named by the generic function. For
example, all <code>show</code> methods would go in R/show-methods.R.</li>
</ul>
<p>A Collates: field in the DESCRIPTION file may be necessary to order
class and method definitions appropriately during package
installation.</p>
</div>
<div id="parallel-recommendations" class="section level3" number="17.2.7">
<h3>
<span class="header-section-number">17.2.7</span> Parallel Recommendations<a class="anchor" aria-label="anchor" href="#parallel-recommendations"><i class="fas fa-link"></i></a>
</h3>
<p>We recommend using <a href="https://bioconductor.org/packages/devel/BiocParallel">BiocParallel</a>. It provides a consistent
interface to the user and supports the major parallel computing
styles: forks and processes on a single computer, ad hoc clusters,
batch schedulers and cloud computing. By default, <code>BiocParallel</code>
chooses a parallel back-end appropriate for the OS and is supported
across Unix, Mac and Windows. Coding requirements for <code>BiocParallel</code>
are:</p>
<ul>
<li>Use <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code>-style iteration instead of explicit for loops.</li>
<li>The <code>FUN</code> argument to <code>bplapply()</code> must be a self-contained
function; all symbols used in the function are from default R
packages, from packages <code><a href="https://rdrr.io/r/base/library.html">require()</a></code>’ed in the function, or passed in
as arguments.</li>
<li>Allow the user to specify the BiocParallel back-end. Do this by
invoking <code>bplapply()</code> <em>without</em> specifying <code>BPPARAM</code>; the user can
then override the default choice with <code>BiocParallel::register()</code>.</li>
</ul>
<p>For more information see the <a href="https://bioconductor.org/packages/devel/bioc/vignettes/BiocParallel/inst/doc/Introduction_To_BiocParallel.pdf">BiocParallel vignette</a>.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="common-bioconductor-methods-and-classes.html"><span class="header-section-number">16</span> Common Bioconductor Methods and Classes</a></div>
<div class="next"><a href="c-fortran.html"><span class="header-section-number">18</span> C and Fortran code</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#robust-and-efficient-code"><span class="header-section-number">17</span> Robust and Efficient Code</a></li>
<li><a class="nav-link" href="#guiding-principles"><span class="header-section-number">17.1</span> Guiding Principles</a></li>
<li>
<a class="nav-link" href="#common-advice"><span class="header-section-number">17.2</span> Common Advice</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#vectorize"><span class="header-section-number">17.2.1</span> Vectorize</a></li>
<li><a class="nav-link" href="#pre-allocate-and-fill-if-iterations-are-necessary"><span class="header-section-number">17.2.2</span> ‘Pre-allocate and fill’ if iterations are necessary</a></li>
<li><a class="nav-link" href="#avoid-1n-style-iterations"><span class="header-section-number">17.2.3</span> Avoid 1:n style iterations</a></li>
<li><a class="nav-link" href="#re-use-existing-functionality"><span class="header-section-number">17.2.4</span> Re-use existing functionality</a></li>
<li><a class="nav-link" href="#re-use-existing-classes"><span class="header-section-number">17.2.5</span> Re-use existing classes</a></li>
<li><a class="nav-link" href="#essential-s4-interface"><span class="header-section-number">17.2.6</span> Essential S4 interface</a></li>
<li><a class="nav-link" href="#parallel-recommendations"><span class="header-section-number">17.2.7</span> Parallel Recommendations</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/Bioconductor/pkgrevdocs/blob/master/efficient-code.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/Bioconductor/pkgrevdocs/edit/master/efficient-code.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Bioconductor Packages: Development, Maintenance, and Peer Review</strong>" was written by Kevin Rue-Albrecht, Daniela Cassol, Johannes Rainer, Lori Shepherd. It was last built on 2021-12-01.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
